<!DOCTYPE html>
<html lang="en">
<head>
    <title>签收</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0,viewport-fit=cover">
    <link rel="stylesheet" type="text/css" href="__STATIC__/plugins/weui/css/weui.min.css">
    <!-- <link rel="stylesheet" type="text/css" href="__STATIC__/css/font-awesome.min.css"> -->
    <link rel="stylesheet" type="text/css" href="__STATIC__/css/style.css">
    <link rel="stylesheet" type="text/css" href="__STATIC__/css/application.css">
    <script type="text/javascript" src="__STATIC__/plugins/jquery.min.js"></script>
    <script type="text/javascript" src="__STATIC__/plugins/windownFont.js"></script>
    <script type="text/javascript" src="__STATIC__/plugins/raty/jquery.raty.js"></script>
    <script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
</head>
<body id="sm_body">
    <!-- scan page start -->
    <div class="sm_out_div" id="sm_scan_div">    
    <!--  <p id="scan_p" onclick="test()">扫一扫</p> -->
    <p id="scan_p">扫一扫</p>
     <h2>查看货物清单</h2>
    <img src="__STATIC__/images/picture.png" id="scan_img" onclick="return false" >
    <div id="scan_div"></div>
   </div>
    <!-- scan page end -->
    <!-- scan good list start -->
  <div class="sm_out_div" style="height: 8rem;background-color: white" id="container_panel" hidden>
    <div class="goods_list">货品列表</div>
    <div id="conatiner" class="container">
    <!-- <div class="sm_panel"><div class="sm_cell"><div class="sm_cell_img"><span class="fa fa-table fa-lg"></span></div><div class="sm_cell_text"><p>汽油&nbsp;&nbsp;&nbsp;&nbsp;<span class="sm_cell_span">(石油、天然气及制品)</span></p>
</div></div><div class="sm_cell"><div class="sm_cell_img"><span class="fa fa-list fa-lg"></div><div class="sm_cell_text"><p>1件/60000.0000千克/60.00立方米</p></div></div></div> -->
    </div>
     <div class="comment_div">
        <a href="javascript:signGoods()" class="sm_btn btn_comment">签&emsp; 收</a>
        <a href="javascript:enterScan()" class="sm_btn btn_scan">继续扫码</a>
    </div>
    <img src="__STATIC__/images/picture_car.png" id="car_img" onclick="return false">
</div>
 <!-- scan good list end -->
<!-- 弹出层 -->
<div id="container_grade" hidden>
    <div class="weui-mask weui-animate-fade-in"></div>
    <div class="weui-picker weui-animate-slide-up">
        <div class="weui-picker__hd">
            <a href="javascript:closePanel();" data-action="cancel" class="weui-picker__action">取消</a>
            <a href="javascript:sendComment();" data-action="select" class="weui-picker__action a_sure"
               id="weui-picker-confirm">确定</a>
        </div>
        <!-- raty -->
        <div id="raty_container">
            <div id="star"></div>
        </div>
        <div id="raty_button">
            <button class="weui-btn weui-btn_mini weui-btn_default">送货及时</button>
            <button class="weui-btn weui-btn_mini weui-btn_default">货物完好</button>
            <button class="weui-btn weui-btn_mini weui-btn_default">提醒到位</button>
            <button class="weui-btn weui-btn_mini weui-btn_default">司机人好</button>
            <button class="weui-btn weui-btn_mini weui-btn_default">及时提醒</button>
            <button class="weui-btn weui-btn_mini weui-btn_default">部分货品损坏</button>
            <button class="weui-btn weui-btn_mini weui-btn_default">储存方式好</button>
        </div>
        <div class="weui-picker__bd">
            <div class="weui-picker__group">
                <div class="weui-picker__mask">
                    <div class="weui-cells weui-cells_form">
                        <div class="weui-cell">
                            <div class="weui-cell__bd">
                                <textarea class="weui-textarea" id="comment_textarea" placeholder=""
                                          rows="8"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="toast" style="display: none;">
    <div class="weui-mask_transparent"></div>
    <div class="weui-toast">
        <i class="weui-icon-success-no-circle weui-icon_toast"></i>
        <p class="weui-toast__content">已完成</p>
    </div>
</div>
<script type="text/javascript">
    var _getWechatSignUrl = '/shouhuo/public/admin/scan/getJsapiTicket';
    // 获取微信签名 将url当参数传入到后台
    $.post(_getWechatSignUrl, {
        'url': location.href.split('#')[0]
    }, function (o) {
        wxConfig(o.appId, o.timestamp, o.nonceStr, o.signature);
    }, 'json');

    function wxConfig(_appId, _timestamp, _nonceStr, _signature) {
        wx.config({
            debug: false,//true 调试模式 返回信息  上线使用false
            appId: _appId,
            timestamp: _timestamp,
            nonceStr: _nonceStr,
            signature: _signature,
            jsApiList: ['scanQRCode']
        });
    }
    
    function scanCode() {
        wx.scanQRCode({
            needResult: 1,
            scanType: ["qrCode", "barCode"], // 可以指定扫二维码还是一维码，默认二者都有
            success: function (res) {
                getBarCodeData(JSON.parse(res.resultStr).pk);
            }
        });
    }

    function test() {
        var data = {};
        data.pk = "c229deea86754ad8a9fb8be43018b9ff";
        data.userCode = localStorage.getItem("username");
        sessionStorage.setItem("pk", data.pk);
        getBarCodeData(data.pk);
    }

    // 根据二维码扫描结果查询数据
    function getBarCodeData(data) {
        $.post("/shouhuo/public/admin/scan/getCodeData", {
            pk: data,
            userCode: localStorage.getItem("username")
        }, function (res) {
            //存放pk时进行判断
            sessionStorage.setItem("pk", data);
            var str = "";
            $("#conatiner").html(str);
            var list = res.list;
            if (list.length > 0) {
                for (i in list) {
                    str+="<div class=\"sm_panel\"><div class=\"sm_cell\"><div class=\"sm_cell_img\"><img src=\"__STATIC__/images/icon.png\" class=\"sm_img\"></div><div class=\"sm_cell_text\"><p>"+ list[i].goodsName  +"&nbsp;&nbsp;&nbsp;&nbsp;<span class='sm_cell_span'>("+list[i].goodsCode + ")</span>" +"</p>\n</div></div>"+
            "<div class=\"sm_cell\"><div class=\"sm_cell_img\"><img src=\"__STATIC__/images/icon1.png\" class=\"sm_img\"></div><div class=\"sm_cell_text\"><p>" + list[i].num + "件/" + list[i].weight + list[i].volumeUnit + "/" + list[i].volume + list[i].weightUnit + "</p></div></div></div>"
                }
                $("#sm_scan_div").hide();
                $("#container_panel").show();
                $("#conatiner").html(str);
            } else {
                $("#container_panel").hide();
            }
        }, 'json');
    }
    
    //弹出层展示面板
    function showPanel() {
        initRaty();
        $("#container_grade").show();
    }
    
    //弹出层关闭面板
    function closePanel() {
        $("#container_grade").hide();
        $("#comment_textarea").val("");
        $("#raty_button button").each(function (index) {
            $(this).attr("class", "weui-btn weui-btn_mini weui-btn_default");
        });
        initRaty();
        sessionStorage.setItem("comment","");
    }
    /* 签收接口*/
    function  signGoods() {
        $.post("/shouhuo/public/admin/scan/sendRemark", {
            'pk': sessionStorage.getItem("pk"),
            'userCode': localStorage.getItem("username")
        }, function (resp) {
           /* alert(JSON.stringify(resp));
            if (resp.success == 1) {*/
                showPanel();
           // }
        })
    }
    /*发布评价*/
    function sendComment() {
        var remark = $("#comment_textarea").val();
        var average = $('#star').raty('getScore');
        $.post("/shouhuo/public/admin/scan/sendRemark", {
            'remark': remark,
            'pk': sessionStorage.getItem("pk"),
            'userCode': localStorage.getItem("username"),
            'average':average
        }, function (resp) {
            if (resp.success == 1) {
                var $toast = $('#toast');
                if ($toast.css('display') != 'none') return;
                $toast.fadeIn(100);
                setTimeout(function () {
                    $toast.fadeOut(100);
                }, 2000);
                $("#container_grade").hide();
                $("#comment_textarea").val();
                sessionStorage.setItem("comment","");
            } else {
                alert(resp.message);
            }
        }, 'json');
    };
    //扫码后继续扫码
    function enterScan(){
        $("#container_panel").hide();
        $("#sm_scan_div").show();
    }

    //评分插件初始化
    function initRaty(){
        $('#star').raty({
            path: "/shouhuo/public/static/images/",
            size: 40,
            score:5,
            starHalf: 'star-half-big.png',
            starOff: 'star-off-big.png',
            starOn: 'star-on-big.png',
            click:function (score,evt) {
                sessionStorage.setItem("raty",score);
                $("#comment_textarea").val("评分为"+score+"颗星   "+(sessionStorage.getItem("comment")==null?"":sessionStorage.getItem("comment")));
            }
        });
      sessionStorage.setItem("raty",5);
    }

    //按钮的样式切换
    $("#raty_button button").each(function (index) {
        $(this).click(function () {
            var classType = $(this).attr("class");
            var textArea = sessionStorage.getItem("comment");
            var ratyGrade = sessionStorage.getItem("raty");
            var data = $(this).html();
            if (classType.indexOf("weui-btn_default")!=-1) {
                $(this).attr("class", "weui-btn weui-btn_mini weui-btn_primary");
                sessionStorage.setItem("comment",textArea?(textArea + "  " + data):data);
                $("#comment_textarea").val("评分为"+ratyGrade+"颗星    "+sessionStorage.getItem("comment"));
            } else {
                $(this).attr("class", "weui-btn weui-btn_mini weui-btn_default");
                sessionStorage.setItem("comment",textArea.replace(data, "").trim());
                $("#comment_textarea").val("评分为"+ratyGrade+"颗星  "+sessionStorage.getItem("comment"));
            }
        })
    })

    $("#scan_div").click(function(){
        scanCode();
    })
</script>
</body>
</html>